# データベース設計

## 概要
つべナビでは、YouTube APIから取得したデータを効率的に管理し、高速なアクセスを実現するためのデータベース設計を行います。主にユーザー情報、YouTubeチャンネル情報、動画データ、分析結果などを保存します。

## データベース選択
- **プライマリデータベース**: PostgreSQL
  - リレーショナルデータの管理
  - 複雑なクエリの実行
  - トランザクション処理

- **キャッシュ層**: Redis
  - 高頻度アクセスデータのキャッシュ
  - セッション管理
  - 一時的な分析データの保持

## スキーマ設計

### users テーブル
```sql
CREATE TABLE users (
  id UUID PRIMARY KEY,
  email VARCHAR(255) UNIQUE NOT NULL,
  password_hash VARCHAR(255) NOT NULL,
  name VARCHAR(255) NOT NULL,
  profile_image_url VARCHAR(512),
  created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  last_login_at TIMESTAMP,
  subscription_plan VARCHAR(50) DEFAULT 'free',
  subscription_status VARCHAR(50) DEFAULT 'active',
  subscription_expires_at TIMESTAMP,
  is_admin BOOLEAN DEFAULT FALSE
);
```

### youtube_accounts テーブル
```sql
CREATE TABLE youtube_accounts (
  id UUID PRIMARY KEY,
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  youtube_channel_id VARCHAR(255) NOT NULL,
  access_token VARCHAR(2048),
  refresh_token VARCHAR(2048),
  token_expires_at TIMESTAMP,
  created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  UNIQUE(user_id, youtube_channel_id)
);
```

### youtube_channels テーブル
```sql
CREATE TABLE youtube_channels (
  id UUID PRIMARY KEY,
  youtube_account_id UUID NOT NULL REFERENCES youtube_accounts(id) ON DELETE CASCADE,
  youtube_channel_id VARCHAR(255) NOT NULL,
  title VARCHAR(255) NOT NULL,
  description TEXT,
  thumbnail_url VARCHAR(512),
  banner_url VARCHAR(512),
  subscriber_count INTEGER,
  video_count INTEGER,
  view_count BIGINT,
  created_date TIMESTAMP,
  country VARCHAR(50),
  custom_url VARCHAR(255),
  keywords TEXT[],
  last_fetched_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  UNIQUE(youtube_account_id, youtube_channel_id)
);
```

### youtube_videos テーブル
```sql
CREATE TABLE youtube_videos (
  id UUID PRIMARY KEY,
  youtube_channel_id UUID NOT NULL REFERENCES youtube_channels(id) ON DELETE CASCADE,
  youtube_video_id VARCHAR(255) NOT NULL,
  title VARCHAR(255) NOT NULL,
  description TEXT,
  thumbnail_url VARCHAR(512),
  published_at TIMESTAMP NOT NULL,
  duration_seconds INTEGER,
  view_count INTEGER,
  like_count INTEGER,
  comment_count INTEGER,
  tags TEXT[],
  category_id VARCHAR(100),
  privacy_status VARCHAR(50),
  last_fetched_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  UNIQUE(youtube_channel_id, youtube_video_id)
);
```

### video_stats_history テーブル
```sql
CREATE TABLE video_stats_history (
  id UUID PRIMARY KEY,
  youtube_video_id UUID NOT NULL REFERENCES youtube_videos(id) ON DELETE CASCADE,
  snapshot_date DATE NOT NULL,
  view_count INTEGER,
  like_count INTEGER,
  comment_count INTEGER,
  created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  UNIQUE(youtube_video_id, snapshot_date)
);
```

### channel_stats_history テーブル
```sql
CREATE TABLE channel_stats_history (
  id UUID PRIMARY KEY,
  youtube_channel_id UUID NOT NULL REFERENCES youtube_channels(id) ON DELETE CASCADE,
  snapshot_date DATE NOT NULL,
  subscriber_count INTEGER,
  view_count BIGINT,
  video_count INTEGER,
  created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  UNIQUE(youtube_channel_id, snapshot_date)
);
```

### reports テーブル
```sql
CREATE TABLE reports (
  id UUID PRIMARY KEY,
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  report_type VARCHAR(100) NOT NULL,
  youtube_channel_id UUID REFERENCES youtube_channels(id) ON DELETE SET NULL,
  youtube_video_id UUID REFERENCES youtube_videos(id) ON DELETE SET NULL,
  date_range_start DATE,
  date_range_end DATE,
  format VARCHAR(50) NOT NULL,
  status VARCHAR(50) NOT NULL DEFAULT 'pending',
  file_url VARCHAR(512),
  created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  completed_at TIMESTAMP
);
```

### user_preferences テーブル
```sql
CREATE TABLE user_preferences (
  id UUID PRIMARY KEY,
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  theme VARCHAR(50) DEFAULT 'light',
  notification_email BOOLEAN DEFAULT TRUE,
  notification_web BOOLEAN DEFAULT TRUE,
  default_dashboard_view VARCHAR(100) DEFAULT 'summary',
  created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  UNIQUE(user_id)
);
```

## インデックス設計

### ユーザー関連
```sql
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_subscription_status ON users(subscription_status);
```

### チャンネル関連
```sql
CREATE INDEX idx_youtube_channels_youtube_channel_id ON youtube_channels(youtube_channel_id);
CREATE INDEX idx_youtube_channels_youtube_account_id ON youtube_channels(youtube_account_id);
CREATE INDEX idx_youtube_channels_last_fetched_at ON youtube_channels(last_fetched_at);
```

### 動画関連
```sql
CREATE INDEX idx_youtube_videos_youtube_video_id ON youtube_videos(youtube_video_id);
CREATE INDEX idx_youtube_videos_youtube_channel_id ON youtube_videos(youtube_channel_id);
CREATE INDEX idx_youtube_videos_published_at ON youtube_videos(published_at);
CREATE INDEX idx_youtube_videos_view_count ON youtube_videos(view_count);
CREATE INDEX idx_youtube_videos_last_fetched_at ON youtube_videos(last_fetched_at);
```

### 統計データ関連
```sql
CREATE INDEX idx_video_stats_history_youtube_video_id ON video_stats_history(youtube_video_id);
CREATE INDEX idx_video_stats_history_snapshot_date ON video_stats_history(snapshot_date);
CREATE INDEX idx_channel_stats_history_youtube_channel_id ON channel_stats_history(youtube_channel_id);
CREATE INDEX idx_channel_stats_history_snapshot_date ON channel_stats_history(snapshot_date);
```

### レポート関連
```sql
CREATE INDEX idx_reports_user_id ON reports(user_id);
CREATE INDEX idx_reports_status ON reports(status);
CREATE INDEX idx_reports_created_at ON reports(created_at);
```

## データマイグレーション戦略
- Prisma Migrate を使用したマイグレーション管理
- バージョン管理されたマイグレーションファイル
- ロールバック可能な設計
- 本番環境用とテスト環境用の分離したマイグレーション実行

## バックアップ戦略
- 日次フルバックアップ
- 1時間ごとの増分バックアップ
- 30日間のバックアップ保持
- 地理的に分散したバックアップストレージ

## パフォーマンス最適化
- クエリパフォーマンスの定期的な監視
- 必要に応じたパーティショニング（特にhistoryテーブル）
- 統計データの集計ビュー作成
- 長期間アクセスされていないデータのアーカイブ処理 