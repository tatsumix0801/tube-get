# コア機能の処理フロー

## 1. YouTube チャンネル連携プロセス

### 1.1 OAuth 認証フロー
```
┌─────────────┐      ┌─────────────┐      ┌─────────────┐      ┌─────────────┐
│   ユーザー   │      │  フロントエンド │      │  バックエンド  │      │  YouTube API │
└──────┬──────┘      └──────┬──────┘      └──────┬──────┘      └──────┬──────┘
        │                   │                    │                     │
        │  連携開始要求      │                    │                     │
        │──────────────────>│                    │                     │
        │                   │                    │                     │
        │                   │  OAuth URL 要求    │                     │
        │                   │───────────────────>│                     │
        │                   │                    │                     │
        │                   │                    │  認証URLを生成      │
        │                   │                    │─────────────────────>
        │                   │                    │                     │
        │                   │  認証URL返却       │  認証URL返却        │
        │                   │<───────────────────│<────────────────────│
        │                   │                    │                     │
        │ YouTube認証画面表示│                    │                     │
        │<──────────────────│                    │                     │
        │                   │                    │                     │
        │  認証許可          │                    │                     │
        │──────────────────>│                    │                     │
        │                   │                    │                     │
        │                   │  認証コード送信     │                     │
        │                   │───────────────────>│                     │
        │                   │                    │                     │
        │                   │                    │  アクセストークン要求 │
        │                   │                    │─────────────────────>
        │                   │                    │                     │
        │                   │                    │  トークン発行        │
        │                   │                    │<────────────────────│
        │                   │                    │                     │
        │                   │                    │  トークン保存        │
        │                   │                    │──┐                  │
        │                   │                    │  │                  │
        │                   │                    │<─┘                  │
        │                   │                    │                     │
        │                   │  連携完了通知       │                     │
        │                   │<───────────────────│                     │
        │                   │                    │                     │
        │  連携完了表示      │                    │                     │
        │<──────────────────│                    │                     │
```

### 1.2 チャンネルデータ初期取得
1. アクセストークンを用いてYouTube Data APIへ接続
2. チャンネル基本情報の取得（タイトル、概要、サムネイル等）
3. チャンネル統計情報の取得（登録者数、総視聴回数等）
4. 動画一覧の取得（最新50件）
5. 各動画の詳細情報取得（メタデータ、統計情報）
6. データベースへの保存

## 2. データ同期プロセス

### 2.1 定期同期処理フロー
```
┌─────────────┐        ┌─────────────┐        ┌─────────────┐
│  スケジューラ │        │  バックエンド  │        │  YouTube API │
└──────┬──────┘        └──────┬──────┘        └──────┬──────┘
        │                     │                      │
        │  定期実行トリガー    │                      │
        │────────────────────>│                      │
        │                     │                      │
        │                     │  更新対象チャンネル取得 │
        │                     │─────┐                │
        │                     │     │                │
        │                     │<────┘                │
        │                     │                      │
        │                     │  トークン検証         │
        │                     │─────┐                │
        │                     │     │                │
        │                     │<────┘                │
        │                     │                      │
        │                     │  チャンネルデータ要求   │
        │                     │──────────────────────>
        │                     │                      │
        │                     │  チャンネルデータ返却   │
        │                     │<─────────────────────│
        │                     │                      │
        │                     │  データベース更新      │
        │                     │─────┐                │
        │                     │     │                │
        │                     │<────┘                │
        │                     │                      │
        │                     │  動画一覧要求         │
        │                     │──────────────────────>
        │                     │                      │
        │                     │  動画一覧返却         │
        │                     │<─────────────────────│
        │                     │                      │
        │                     │  新規動画の詳細要求    │
        │                     │──────────────────────>
        │                     │                      │
        │                     │  動画詳細返却         │
        │                     │<─────────────────────│
        │                     │                      │
        │                     │  データベース更新      │
        │                     │─────┐                │
        │                     │     │                │
        │                     │<────┘                │
        │                     │                      │
        │                     │  統計履歴更新         │
        │                     │─────┐                │
        │                     │     │                │
        │                     │<────┘                │
        │                     │                      │
        │  処理完了ログ        │                      │
        │<────────────────────│                      │
```

### 2.2 データ同期スケジュール
- チャンネル基本情報: 24時間ごと
- チャンネル統計情報: 6時間ごと
- 動画メタデータ: 24時間ごと
- 動画統計情報: 6時間ごと（直近90日の動画）、24時間ごと（それ以前の動画）
- 新規動画検出: 1時間ごと（アクティブチャンネル）

## 3. 分析エンジンプロセス

### 3.1 データ分析フロー
1. **データ取得**: 対象期間のチャンネルおよび動画統計履歴を取得
2. **データ前処理**:
   - 異常値の検出と処理
   - 欠損データの補完
   - 時系列データの正規化
3. **分析処理**:
   - トレンド分析（成長率、変化率の計算）
   - パターン検出（周期性、特異点の特定）
   - 相関分析（関連指標間の関係性）
   - パフォーマンスランキング
4. **結果の保存**:
   - 分析結果のデータベース保存
   - キャッシュへの格納（高頻度アクセス用）

### 3.2 リアルタイム分析処理
```
┌─────────────┐      ┌─────────────┐      ┌─────────────┐
│   ユーザー   │      │  フロントエンド │      │  バックエンド  │
└──────┬──────┘      └──────┬──────┘      └──────┬──────┘
        │                   │                    │
        │  分析リクエスト    │                    │
        │──────────────────>│                    │
        │                   │                    │
        │                   │  分析API呼び出し    │
        │                   │───────────────────>│
        │                   │                    │
        │                   │                    │  データ取得
        │                   │                    │─────┐
        │                   │                    │     │
        │                   │                    │<────┘
        │                   │                    │
        │                   │                    │  データ前処理
        │                   │                    │─────┐
        │                   │                    │     │
        │                   │                    │<────┘
        │                   │                    │
        │                   │                    │  分析処理
        │                   │                    │─────┐
        │                   │                    │     │
        │                   │                    │<────┘
        │                   │                    │
        │                   │                    │  結果整形
        │                   │                    │─────┐
        │                   │                    │     │
        │                   │                    │<────┘
        │                   │                    │
        │                   │  分析結果返却      │
        │                   │<───────────────────│
        │                   │                    │
        │  結果表示          │                    │
        │<──────────────────│                    │
```

## 4. レポート生成プロセス

### 4.1 レポート生成フロー
```
┌─────────────┐      ┌─────────────┐      ┌─────────────┐
│   ユーザー   │      │  バックエンド  │      │  ワーカー    │
└──────┬──────┘      └──────┬──────┘      └──────┬──────┘
        │                   │                    │
        │  レポート要求      │                    │
        │──────────────────>│                    │
        │                   │                    │
        │                   │  要求検証          │
        │                   │─────┐             │
        │                   │     │             │
        │                   │<────┘             │
        │                   │                    │
        │                   │  レポートジョブ作成  │
        │                   │─────┐             │
        │                   │     │             │
        │                   │<────┘             │
        │                   │                    │
        │                   │  ジョブエンキュー    │
        │                   │───────────────────>│
        │                   │                    │
        │  ジョブID返却      │                    │
        │<──────────────────│                    │
        │                   │                    │
        │                   │                    │  データ取得
        │                   │                    │─────┐
        │                   │                    │     │
        │                   │                    │<────┘
        │                   │                    │
        │                   │                    │  テンプレート適用
        │                   │                    │─────┐
        │                   │                    │     │
        │                   │                    │<────┘
        │                   │                    │
        │                   │                    │  レポート生成
        │                   │                    │─────┐
        │                   │                    │     │
        │                   │                    │<────┘
        │                   │                    │
        │                   │                    │  ファイル保存
        │                   │                    │─────┐
        │                   │                    │     │
        │                   │                    │<────┘
        │                   │                    │
        │                   │  生成完了通知       │
        │                   │<───────────────────│
        │                   │                    │
        │                   │  通知処理          │
        │                   │─────┐             │
        │                   │     │             │
        │                   │<────┘             │
        │                   │                    │
        │  完了通知          │                    │
        │<──────────────────│                    │
```

### 4.2 レポートテンプレート
1. **チャンネル概要レポート**:
   - チャンネル基本情報
   - 成長指標（登録者数、総再生数の推移）
   - コンテンツパフォーマンス分析
   - 改善提案

2. **動画パフォーマンスレポート**:
   - 個別動画の詳細分析
   - エンゲージメント指標
   - 類似動画との比較
   - パフォーマンス評価

3. **トレンド分析レポート**:
   - 期間別パフォーマンス比較
   - 成長率分析
   - キーワード効果分析
   - 将来予測

## 5. ユーザー認証プロセス

### 5.1 認証フロー
```
┌─────────────┐      ┌─────────────┐      ┌─────────────┐
│   ユーザー   │      │  フロントエンド │      │  バックエンド  │
└──────┬──────┘      └──────┬──────┘      └──────┬──────┘
        │                   │                    │
        │  認証情報入力      │                    │
        │──────────────────>│                    │
        │                   │                    │
        │                   │  認証リクエスト      │
        │                   │───────────────────>│
        │                   │                    │
        │                   │                    │  認証情報検証
        │                   │                    │─────┐
        │                   │                    │     │
        │                   │                    │<────┘
        │                   │                    │
        │                   │                    │  JWTトークン生成
        │                   │                    │─────┐
        │                   │                    │     │
        │                   │                    │<────┘
        │                   │                    │
        │                   │  トークン返却       │
        │                   │<───────────────────│
        │                   │                    │
        │                   │  トークン保存       │
        │                   │─────┐             │
        │                   │     │             │
        │                   │<────┘             │
        │                   │                    │
        │  認証成功表示      │                    │
        │<──────────────────│                    │
```

### 5.2 セッション管理
1. **トークン生成**: JWT（JSON Web Token）の生成
2. **トークン保存**: クライアントサイドのセキュアなストレージに保存
3. **トークン検証**: 各API呼び出し時の認証ヘッダー検証
4. **トークン更新**: 期限切れ間近のトークン自動更新
5. **トークン無効化**: ログアウト時のトークン無効化 